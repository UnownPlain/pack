name: Update Mods (Quilt)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  Update-mods:
    name: Update mods
    runs-on: ubuntu-latest
    steps:
      - name: Clone repo
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.19'
          check-latest: true
      - name: Download Packwiz
        run: go install github.com/packwiz/packwiz@latest
      - name: Update Mods (1.20.3)
        run: |
          cd quilt/1.20.3
          packwiz update --all -y
          cd ..
      - name: Update Mods (1.20.2)
        run: |
          cd quilt/1.20.2
          packwiz update --all -y
          cd ..
      - name: Update mods (1.19.4)
        run: |
          cd quilt/1.19.4
          packwiz update --all -y
          cd ..
      - name: Update mods (1.18.2)
        run: |
          cd quilt/1.18.2
          packwiz update --all -y
          cd ..
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git diff) ]]; then
            echo "updated=true" >> $GITHUB_OUTPUT
          fi
      - name: Prepare Modrith pack files
        if: ${{ steps.changes.outputs.updated == 'true' }}
        run: |
          cd quilt/1.20.3
          packwiz mr export
          mv "UnownPlain's Modpack-1.20.3.mrpack" UnownPlains-Modpack-1.20.3.mrpack
          cd ..
          cd 1.20.2
          packwiz mr export
          mv "UnownPlain's Modpack-1.20.2.mrpack" UnownPlains-Modpack-1.20.2.mrpack
          cd ..
          cd 1.19.4
          packwiz mr export
          mv "UnownPlain's Modpack-1.19.4.mrpack" UnownPlains-Modpack-1.19.4.mrpack
          cd ..
          cd 1.18.2
          packwiz mr export
          mv "UnownPlain's Modpack-1.18.2.mrpack" UnownPlains-Modpack-1.18.2.mrpack
          cd ..
      - name: Release modpack
        if: ${{ steps.changes.outputs.updated == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Modpack-Quilt
          name: UnownPlain's Modpack (Quilt)
          prerelease: false
          files: |
            quilt/1.20.3/UnownPlains-Modpack-1.20.3.mrpack
            quilt/1.20.2/UnownPlains-Modpack-1.20.2.mrpack
            quilt/1.19.4/UnownPlains-Modpack-1.19.4.mrpack
            quilt/1.18.2/UnownPlains-Modpack-1.18.2.mrpack
      - name: Commit changes, if any
        if: ${{ steps.changes.outputs.updated == 'true' }}
        run: |
          git config user.name "UnownBot"
          git config user.email "gitbot@unownplain.dev"
          git pull
          git add .
          git commit -m "Update mods"
          git push origin main
